# Tools Specification

## Purpose

Defines the tool framework and each tool's behavior, inputs, outputs, and risk levels. Tools allow the assistant to interact with external services and storage.

## Requirements

### Requirement: Tool Definition

Every tool SHALL be defined with a Zod schema for input/output validation and an explicit risk level.

### Requirement: Risk Levels

The system SHALL classify tools into three risk levels:

- **`low`**: Execute immediately. Examples: email listing, calendar availability check, AI-created event details, file reading.
- **`medium`**: Execute and report the action in the reply. Examples: file writing.
- **`high`**: Require approval before execution. Examples: user-created event details, calendar mutations, file deletion.

---

### Requirement: Forwarded Email Reader — Design Rationale

The system SHALL receive emails via forwarding to a dedicated Cloudflare Email Workers address, rather than accessing mailboxes directly via provider APIs.

This approach SHALL NOT require broad access permissions to the user's email provider.

The user SHALL explicitly choose what the assistant can read by forwarding specific emails. Semi-automation via email provider filter rules (auto-forward) SHOULD be supported.

### Requirement: Forwarded Email Reader — Ingestion

When an email arrives at the dedicated address (e.g., `inbox@your-domain.com`), the system SHALL:

1. Parse the MIME content using `postal-mime`.
2. Store metadata (sender, subject, date) and an LLM-generated summary in D1.
3. Store raw data (full body text and attachments) in R2.
4. Optionally send a new-email notification to Discord.

The summary SHALL be a concise description of the email's content (enough to understand "what it's about"), generated by a single LLM call at ingestion time.

### Requirement: Forwarded Email Reader — Tools

The system SHALL provide the following email tools:

- **`search_emails`** (risk: `low`): Keyword search over subject and summary in D1. Returns sender, subject, date, and summary.
- **`read_email`** (risk: `low`): Retrieve the full email body from R2 for a specific email.

---

### Requirement: Calendar — Protocol

The system SHALL connect to iCloud CalDAV using the `tsdav` library. Authentication SHALL use an Apple ID and an app-specific password.

The system SHOULD abstract over CalDAV so that switching to another CalDAV-compatible provider (e.g., Google Calendar) is straightforward.

### Requirement: Calendar — Scope Restriction

The system SHALL operate on a single dedicated calendar in iCloud (e.g., "AI Assistant Shared") only.

The system SHALL NOT have access to all events in the user's main calendar.

Returned fields SHALL be limited to title, time, and all-day flag. Participant lists and meeting notes SHALL be excluded.

### Requirement: Calendar — Tools

The system SHALL provide the following calendar tools:

- **`get_events_availability`** (risk: `low`): Returns time slots only (start, end, all-day flag) with no titles or details.
- **`get_events_details`** (risk: dynamic, see below): Returns events with titles and details.
- **`create_event`** (risk: `high`): Creates an event. Approval required.
- **`update_event`** (risk: `high`): Updates an event. Approval required.
- **`delete_event`** (risk: `high`): Deletes an event. Approval required.

### Requirement: Calendar — Two-Axis Read Permission

The risk level of `get_events_details` SHALL be determined dynamically by two axes:

**Axis 1 — Information Granularity:**
`get_events_availability` SHALL return only time slots with no titles or details, so that availability checks ("Am I free Wednesday?") can always be answered instantly without approval.

**Axis 2 — Event Origin:**
The system SHALL record the UID (CalDAV event identifier) of every event it creates in D1. When `get_events_details` is called:

- If the event's UID exists in D1 (created by the assistant): risk is `low` (immediate access).
- If the event's UID is not in D1 (created by the user directly): risk is `high` (approval required).

### Requirement: Calendar — Workers Compatibility

The `tsdav` library is built for Node.js. It SHOULD work under Workers' `nodejs_compat` compatibility flag. If incompatible, the system SHALL fall back to a thin wrapper that constructs CalDAV HTTP requests directly.

---

### Requirement: File Operations

The system SHALL use an R2 bucket as a sandboxed file store. There SHALL be no access to local file systems.

Path traversal SHALL be prevented by allowing only alphanumeric characters, hyphens, underscores, slashes, and dots in file keys.

The system SHALL provide the following file tools:

- **`list_files`** (risk: `low`).
- **`read_file`** (risk: `low`).
- **`write_file`** (risk: `medium`, reported).
- **`delete_file`** (risk: `high`, approval required).

---

### Requirement: Web Search

The system SHALL provide a web search tool using a search API (e.g., Tavily) that requires a single API key.

Risk level SHALL be `low`.

Phase 1 SHALL NOT include full page browsing (fetching and rendering entire pages).
